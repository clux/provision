---
- hosts: all
  connection: local
  user: root
  gather_facts: false

  tasks:
  - name: sudo
    pacman: name=sudo state=installed

  - name: ensure {{ user }} exists
    user:
      name={{ user }}
      state=present
      groups=audio,video,games,rfkill,uucp,wheel,sys,lp
      append=yes

  - name: allow wheel users to sudo without pass
    lineinfile:
      dest: /etc/sudoers
      line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'

  - name: enable multilib for steam
    lineinfile:
      dest=/etc/pacman.conf
      backrefs=yes
      regexp="^\#\[multilib\]"
      line="[multilib]\nInclude = /etc/pacman.d/mirrorlist"

  # NB: These scripts fails the first 2/3 times
  - script: scripts/localectl.sh
    register: localectl_result
    changed_when: "localectl_result.rc != 0"
    ignore_errors: true
  - script: scripts/timedatectl.sh
    register: timedatectl_result
    changed_when: "timedatectl_result.rc != 0"
    ignore_errors: true

  - name: "Update cache after changing pacman settings"
    pacman: update_cache=yes

  - name: install NVIDIA display drivers and choice dependencies
    pacman:
      name:
      - 'nvidia'
      - 'nvidia-utils'
      - 'nvidia-settings'
      state: installed
    when: display_driver == "nvidia"

  - name: install MESA display drivers and choice dependencies
    pacman:
      # NB: may want mesa-git
      name: ['mesa', 'mesa-libgl', 'wayland']
      state: installed
    when: display_driver == "mesa"

  - name: install core packages
    pacman:
      name:
      - git
      - openssh
      - chromium
      - alacritty
      state: installed
  - name: install fonts
    pacman:
      name:
      - ttf-dejavu
      - ttf-liberation
      - ttf-inconsolata-nerd
      state: installed

  # TODO: aur install paru-bin as first install?
  # TODO: install rustup from pacman and rustup install stable

  - name: install window manager
    pacman:
      name:
      - hyprland # wayland compositor (deps below picked for this)
      - mako # lightweight Wayland notification daemon
      - pipewire
      - polkit-kde-agent # pulls in qt5..
      - qt6-wayland # qt support, and for xdg-desktop-portal-hyprland
      - grim # Grab images from a Wayland compositor
      - slurp # Select a region in a Wayland compositor
      - hyprpaper # Wayland wallpaper utility with IPC controls
      - rofi # A window switcher, application launcher and dmenu replacement
      - wofi # haven't decided yet...
      - wireplumber
      - sddm # guide said sddm-git but old bug they pointed to. pulls in qt5 tho
    when: display_driver == "mesa"

    # AUR DEPS FOR HYPRLAND
    - name: install aur extras
      aur:
        name:
        - waybar-hyprland # customizable Wayland bar
        #- xdg-desktop-portal-hyprland-git # NB: with -gtk option (compile error, went for outdated main pkg)
        - wlsunset # redshift replacement
      when: display_driver == "mesa"

  - name: install window manager
    pacman:
      name:
      - cinnamon
      - lightdm
      - lightdm-gtk-greeter
      - alsa-utils
      state: installed
    when: display_driver == "nvidia"

  - name: enable lightdm gtk greeter
    lineinfile:
      dest=/etc/lightdm/lightdm.conf
      backrefs=yes
      regexp="^#greeter-session\="
      line="greeter-session=lightdm-gtk-greeter"
    when: display_driver == "nvidia"

  - name: customize lightdm-gtk-greeter
    copy:
      src=templates/{{ item }}
      remote_src=True
      dest=/etc/lightdm/{{ item }}
    with_items:
    - lightdm-gtk-greeter.conf
    - clux.jpg
    - arch-bg.jpeg
    when: display_driver == "nvidia"

  - name: enable key services
    service: name={{ item }} enabled=yes
    with_items:
    #- lightdm (enable manually in case it fails)
    #- NetworkManager

  - name: install deps to ease setup
    pacman:
      name:
      - keychain
      - pass
      - wl-clipboard
      - lsb-release
      state: installed

  - name: clone provision repo
    # TODO: needs a chown {{ user }}:{{ user }} -R /home/{{ user }}/provision
    git:
      repo: https://github.com/clux/provision
      dest: /home/{{ user }}/provision
      update: yes
    become: true
