---
- hosts: all
  connection: local
  user: root
  gather_facts: false

  tasks:
  - name: sudo
    pacman: name=sudo state=installed

  - name: ensure {{ user }} exists
    user:
      name={{ user }}
      state=present
      groups=audio,video,games,rfkill,uucp,wheel,sys,lp
      append=yes

  - name: allow wheel users to sudo without pass
    lineinfile:
      dest: /etc/sudoers
      line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'

  - name: pacman enable multilib for steam
    lineinfile:
      path: /etc/pacman.conf
      backrefs: yes
      regexp: '^\#\[multilib\]'
      line: '[multilib]\nInclude = /etc/pacman.d/mirrorlist'

  - name: pacman enable parallel downloads
    lineinfile:
      path: /etc/pacman.conf
      regexp: '^#ParalllelDownloads ='
      line: 'ParallelDownloads = 5'

  # NB: These scripts fails the first 2/3 times
  - script: scripts/localectl.sh
    register: localectl_result
    changed_when: "localectl_result.rc != 0"
    ignore_errors: true
  - script: scripts/timedatectl.sh
    register: timedatectl_result
    changed_when: "timedatectl_result.rc != 0"
    ignore_errors: true

  - name: "Update cache after changing pacman settings"
    pacman: update_cache=yes

  - name: install MESA display drivers and choice dependencies
    pacman:
      # NB: may want mesa-git
      name: ['mesa', 'mesa-libgl', 'wayland', 'lib32-vulkan-radeon', 'vulkan-radeon', 'amdvlk', 'lib32-amdvlk']
      state: installed
    when: display_driver == "mesa"

  - name: install core packages
    pacman:
      name:
      - git
      - openssh
      - chromium
      - dhcpd
      - alacritty
      - wl-clipboard
      - lsb-release
      state: installed
  - name: install fonts
    pacman:
      name:
      - ttf-dejavu
      - ttf-ubuntu-font-family # browser
      - ttf-liberation # steam
      - ttf-inconsolata-nerd # terminal
      state: installed

  # TODO: aur install paru-bin as first install?
  # TODO: install rustup from pacman and rustup install stable

  - name: install window manager
    pacman:
      name:
      - hyprland # wayland compositor (deps below picked for this)
      - dunst # lightweight, customizable notification daemon
      - pipewire
      - polkit-kde-agent # pulls in qt5..
      - qt6-wayland # qt support
      - xdg-desktop-portal-hyprland
      - grim # Grab images from a Wayland compositor
      - slurp # Select a region in a Wayland compositor
      - hyprpaper # Wayland wallpaper utility with IPC controls
      - wofi # wayland lancher
      - wireplumber
      - gammastep # redshift replacement
      - sddm # guide said sddm-git but old bug they pointed to. pulls in qt5 tho
    when: display_driver == "mesa"

  # AUR DEPS FOR HYPRLAND
  - name: install aur extras
    aur:
      name:
      - waybar-hyprland # customizable Wayland bar
      - wleave-git # wlogout fork
    when: display_driver == "mesa"

  # TODO: window manager here

  - name: install deps to ease setup
    pacman:
      name:

      state: installed

  - name: clone provision repo
    # TODO: needs a chown {{ user }}:{{ user }} -R /home/{{ user }}/provision
    git:
      repo: https://github.com/clux/provision
      dest: /home/{{ user }}/provision
      update: yes
    become: true
